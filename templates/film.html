{% extends "base.html" %}

{% block title %}{{ film.name }}{% endblock %}

{% block styles %}
<style>
    .film-container {
        display: flex;
        gap: 30px;
        padding: 30px;
        max-width: 1200px;
        margin: 0 auto;
    }
    .film-poster {
        flex: 1;
        max-width: 500px;
    }
    .film-poster img {
        width: 100%;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    .film-details {
        flex: 1;
    }
    .film-title {
        font-size: 2em;
        margin-bottom: 20px;
        color: #4CAF50;
    }
    .film-meta {
        margin-bottom: 20px;
        color: #aaa;
    }
    .film-description {
        margin-bottom: 30px;
        line-height: 1.6;
    }
    .film-section {
        margin-bottom: 20px;
    }
    .film-section h3 {
        color: #4CAF50;
        margin-bottom: 10px;
    }
    .country-map {
        width: 100%;
        height: 300px;
        object-fit: cover;
        border-radius: 10px;
        margin-top: 10px;
    }
    /* Новые стили для кнопок */
    .film-actions {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #333;
    }
    .film-actions .btn {
        padding: 10px 20px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
    }
    .btn-back {
        background: #4CAF50;
        color: white;
        text-decoration: none;
    }
    .btn-watched {
        background: #2196F3;
        color: white;
    }
    .btn-favorite {
        background: {{ '#ff5252' if is_favorite else '#607d8b' }};
        color: white;
    }
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
    }

    .btn-watched {
        transition: all 0.3s ease;
    }

    .btn-watched:active {
        animation: pulse 0.3s ease;
    }

    .btn-favorite {
        transition: all 0.3s ease;
    }

    .btn-favorite:active {
        animation: bounce 0.4s ease;
    }

    /* Эффект при успешном добавлении */
    .btn-success-effect {
        animation: pulse 0.5s ease, shadow-pulse 0.5s ease;
        background-color: #4CAF50 !important;
    }

    @keyframes shadow-pulse {
        0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
        100% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
    }

    /* Эффект для избранного */
    .btn-favorite-effect {
        animation: bounce 0.6s ease, heart-beat 0.6s ease;
        background-color: #ff5252 !important;
    }

    @keyframes heart-beat {
        0% { transform: scale(1); }
        25% { transform: scale(1.1); }
        50% { transform: scale(1); }
        75% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    /* Добавьте в блок стилей */
    .btn-error-effect {
        animation: shake 0.5s ease;
        background-color: #ff4444 !important;
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        20%, 60% { transform: translateX(-5px); }
        40%, 80% { transform: translateX(5px); }
    }

    .btn i {
        margin-right: 8px;
    }

    .btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="film-container">
    <div class="film-poster">
        <img src="{{ film.picture }}" alt="{{ film.name }}">
    </div>
    <div class="film-details">
        <h1 class="film-title">{{ film.name }}</h1>

        <div class="film-meta">
            <span>{{ film.year }} год</span> |
            <span>{{ film.genre }}</span> |
            <span>★ {{ film.rating }}/10</span>
        </div>

        <div class="film-description" style="min-height: {{ desc_height }};">
            <p>{{ film.description }}</p>
        </div>

        <div class="film-section">
            <h3>Актеры</h3>
            <p>{{ film.actors }}</p>
        </div>

        <div class="film-section">
            <h3>Страна производства</h3>
            <p>{{ film.country }}</p>
            {% if map_image %}
                <img src="{{ url_for('static', filename='uploads/' + map_image) }}"
                     alt="Карта {{ film.country }}" class="country-map">
            {% endif %}
        </div>

        <!-- Блок с кнопками -->
        <div class="film-actions">
            <a href="{{ url_for('index') }}" class="btn btn-back">
                <i class="fas fa-arrow-left"></i> Назад к фильмам
            </a>
            <button id="add-to-watched" class="btn btn-watched" data-movie-id="{{ film.id }}">
                <i class="fas fa-eye"></i> Добавить в просмотренные
            </button>
            <button id="toggle-favorite" class="btn btn-favorite" data-movie-id="{{ film.id }}">
                {% if is_favorite %}
                    <i class="fas fa-heart"></i> Удалить из избранного
                {% else %}
                    <i class="far fa-heart"></i> В избранное
                {% endif %}
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Добавьте эту строку для Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Общий обработчик ошибок
    function handleError(btn, error) {
        console.error('Error:', error);
        btn.classList.add('btn-error-effect');
        setTimeout(() => btn.classList.remove('btn-error-effect'), 1000);
        btn.disabled = false;
        alert(error.message);
    }

    // Обработчик для кнопки "Добавить в просмотренные"
    const watchedBtn = document.getElementById('add-to-watched');
    if (watchedBtn) {
        watchedBtn.addEventListener('click', async function() {
            const btn = this;
            const originalHtml = btn.innerHTML;

            // 1. Блокируем кнопку и показываем загрузку
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Обработка...';
            btn.classList.add('btn-success-effect');

            try {
                // 2. Получаем ID фильма из data-атрибута
                const movieId = btn.dataset.movieId;

                // 3. Отправляем запрос на сервер
                const response = await fetch(`/add-watched/${movieId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    credentials: 'include'
                });

                // 4. Обрабатываем ответ сервера
                if (!response.ok) {
                    throw new Error(await response.text() || 'Ошибка сервера');
                }

                const data = await response.json();

                if (data.success) {
                    // 5. Успешное выполнение - меняем вид кнопки
                    btn.innerHTML = '<i class="fas fa-check"></i> Добавлено';
                    btn.style.backgroundColor = '#4CAF50';

                    // Через 2 секунды скрываем кнопку
                    setTimeout(() => {
                        btn.style.display = 'none';
                    }, 2000);
                } else {
                    throw new Error(data.error || 'Не удалось добавить фильм');
                }
            } catch (error) {
                // 6. Обработка ошибок
                btn.innerHTML = originalHtml;
                handleError(btn, error);
            }
        });
    }

    // Обработчик для кнопки избранного
    const favoriteBtn = document.getElementById('toggle-favorite');
    if (favoriteBtn) {
        favoriteBtn.addEventListener('click', async function() {
            const btn = this;
            btn.disabled = true;
            btn.classList.add('btn-favorite-effect');

            try {
                const movieId = btn.dataset.movieId;
                const response = await fetch(`/toggle-favorite/${movieId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(await response.text() || 'Ошибка сервера');
                }

                const data = await response.json();

                if (data.success) {
                    setTimeout(() => {
                        btn.classList.remove('btn-favorite-effect');
                        btn.innerHTML = data.action === 'added' ?
                            '<i class="fas fa-heart"></i> Удалить из избранного' :
                            '<i class="far fa-heart"></i> В избранное';
                        btn.style.backgroundColor = data.action === 'added' ? '#ff5252' : '#607d8b';
                        btn.disabled = false;
                    }, 1000);
                } else {
                    throw new Error(data.error || 'Не удалось обновить');
                }
            } catch (error) {
                handleError(btn, error);
            }
        });
    }
});
</script>
{% endblock %}